pipeline {
    agent any

    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('Ensure Backend Running') {
            steps {
                sh '''
                sudo -u ubuntu /usr/local/bin/pm2 start backend/app.py \
                  --name flask \
                  --interpreter backend/venv/bin/python \
                  || true
                '''
            }
        }

        stage('Ensure Frontend Running') {
            steps {
                sh '''
                sudo -u ubuntu /usr/local/bin/pm2 start frontend/server.js \
                  --name express \
                  || true
                '''
            }
        }

        stage('Restart Applications') {
            steps {
                sh '''
                sudo -u ubuntu /usr/local/bin/pm2 restart flask
                sudo -u ubuntu /usr/local/bin/pm2 restart express
                '''
            }
        }

        stage('Save PM2 State') {
            steps {
                sh 'sudo -u ubuntu /usr/local/bin/pm2 save'
            }
        }
    }
}
